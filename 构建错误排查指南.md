# GitHub Actions 构建错误排查指南

## 错误信息

```
Annotations
1 error
build
Process completed with exit code 1.
```

这表明 Next.js 构建过程失败。

## 快速排查步骤

### 步骤 1: 查看详细错误日志

在 GitHub Actions 中：

1. **进入 Actions 标签**
2. **点击失败的构建运行**
3. **展开 "Build" 步骤**
4. **查看错误输出**

**关键信息：**
- 错误消息（红色文本）
- 失败的文件和行号
- 错误类型（TypeScript、ESLint、构建等）

---

## 常见构建错误及解决方案

### 错误 1: TypeScript 类型错误

**错误示例：**
```
Type error: Property 'xxx' does not exist on type 'yyy'
```

**可能原因：**
- 类型定义不匹配
- 缺少类型声明

**解决方案：**
1. **检查错误文件**
   - 查看错误提示的文件和行号
   - 修复类型问题

2. **临时解决方案（不推荐）：**
   ```typescript
   // 在 tsconfig.json 中添加
   {
     "compilerOptions": {
       "noEmit": true,
       "skipLibCheck": true  // 跳过库类型检查
     }
   }
   ```

---

### 错误 2: 中间件在静态导出时的问题

**错误示例：**
```
Error: Middleware is not supported in static export
```

**可能原因：**
- `app/middleware.ts` 在静态导出时无法使用

**解决方案：**

**方案 A: 修改 next.config.js（推荐）**

确保只在开发模式使用中间件：

```javascript
// next.config.js
const nextConfig = {
  // 静态导出配置
  ...(process.env.NODE_ENV === 'production' && { 
    output: 'export',
    // 静态导出时忽略中间件
    experimental: {
      missingSuspenseWithCSRBailout: false,
    }
  }),
  // ...
};
```

**方案 B: 重命名中间件文件（如果不需要）**

如果中间件在静态导出时不需要：

```bash
# 重命名文件，让 Next.js 忽略它
mv app/middleware.ts app/middleware.ts.bak
```

---

### 错误 3: 缺少环境变量

**错误示例：**
```
Error: NEXT_PUBLIC_XXX is not defined
```

**解决方案：**

1. **检查工作流文件**
   - 确认环境变量已设置（即使值为空）

2. **修改 deploy.yml**
   ```yaml
   - name: Build
     env:
       NEXT_PUBLIC_FORMSPREE_ID: ${{ secrets.NEXT_PUBLIC_FORMSPREE_ID || '' }}
       NEXT_PUBLIC_WEB3FORMS_KEY: ${{ secrets.NEXT_PUBLIC_WEB3FORMS_KEY || '' }}
     run: npm run build
   ```

---

### 错误 4: 依赖安装失败

**错误示例：**
```
npm ERR! code ELIFECYCLE
npm ERR! errno 1
```

**解决方案：**

1. **检查 package.json**
   - 确认所有依赖版本兼容
   - 检查是否有冲突的依赖

2. **清理并重新安装**
   ```yaml
   # 在 deploy.yml 中添加清理步骤
   - name: Clean install
     run: |
       rm -rf node_modules package-lock.json
       npm install
   ```

---

### 错误 5: 文件路径或导入错误

**错误示例：**
```
Module not found: Can't resolve '@/xxx'
```

**解决方案：**

1. **检查 tsconfig.json 路径别名**
   ```json
   {
     "compilerOptions": {
       "paths": {
         "@/*": ["./*"]
       }
     }
   }
   ```

2. **检查文件是否存在**
   - 确认导入的文件路径正确
   - 检查文件扩展名

---

### 错误 6: 图片或资源文件问题

**错误示例：**
```
Error: Image optimization using Next.js default loader is not compatible with `output: export`
```

**解决方案：**

确认 `next.config.js` 中已设置：
```javascript
images: {
  unoptimized: true,
}
```

---

### 错误 7: 根路径 page.tsx 问题

**可能原因：**
- `app/page.tsx` 使用了 `redirect()`，但在静态导出时可能有问题

**解决方案：**

修改 `app/page.tsx`，使用客户端重定向：

```tsx
// app/page.tsx
'use client';

import {useEffect} from 'react';
import {useRouter} from 'next/navigation';
import {routing} from '@/i18n/routing';

export default function RootPage() {
  const router = useRouter();
  
  useEffect(() => {
    // 客户端重定向
    router.push(`/${routing.defaultLocale}`);
  }, [router]);
  
  return null; // 或显示加载提示
}
```

---

## 改进的工作流配置

### 添加更详细的错误输出

修改 `.github/workflows/deploy.yml`：

```yaml
- name: Build
  env:
    NEXT_PUBLIC_FORMSPREE_ID: ${{ secrets.NEXT_PUBLIC_FORMSPREE_ID || '' }}
    NEXT_PUBLIC_WEB3FORMS_KEY: ${{ secrets.NEXT_PUBLIC_WEB3FORMS_KEY || '' }}
  run: |
    echo "Starting build..."
    npm run build || {
      echo "Build failed!"
      exit 1
    }
    echo "Build completed successfully"
```

### 添加构建前检查

```yaml
- name: Type check
  run: npm run type-check || true  # 不阻止构建，但显示类型错误

- name: Build
  run: npm run build
```

---

## 本地测试构建

在推送之前，先在本地测试构建：

```powershell
# 进入项目目录
cd "f:\Git Pages\isperm-website"

# 设置环境变量（如果需要）
$env:NODE_ENV="production"
$env:NEXT_PUBLIC_FORMSPREE_ID=""
$env:NEXT_PUBLIC_WEB3FORMS_KEY=""

# 清理并安装依赖
Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
Remove-Item package-lock.json -ErrorAction SilentlyContinue
npm install

# 运行构建
npm run build

# 检查输出
Test-Path "out"
```

**如果本地构建成功：**
- 问题可能在 GitHub Actions 环境
- 检查环境变量配置

**如果本地构建失败：**
- 先修复本地错误
- 然后再推送到 GitHub

---

## 调试技巧

### 1. 查看完整构建日志

在 GitHub Actions 中：
- 点击失败的步骤
- 展开所有日志
- 查找第一个错误（通常是根本原因）

### 2. 添加调试输出

在工作流中添加：

```yaml
- name: Debug info
  run: |
    echo "Node version: $(node --version)"
    echo "NPM version: $(npm --version)"
    echo "Current directory: $(pwd)"
    echo "Files in app/:"
    ls -la app/
```

### 3. 分步构建

将构建步骤拆分：

```yaml
- name: Install dependencies
  run: npm ci
  continue-on-error: false

- name: Type check
  run: npm run type-check
  continue-on-error: true  # 不阻止，但显示错误

- name: Build
  run: npm run build
  continue-on-error: false
```

---

## 快速修复方案

### 方案 1: 禁用类型检查（临时）

如果错误是 TypeScript 类型问题：

```yaml
- name: Build
  run: npm run build -- --no-lint
```

### 方案 2: 使用开发模式构建（测试）

```yaml
- name: Build
  env:
    NODE_ENV: development
  run: npm run build
```

**注意：** 这只是用于测试，生产环境应该使用生产构建。

---

## 需要您提供的信息

为了更准确地诊断问题，请提供：

1. **完整的错误消息**
   - 从 GitHub Actions 日志中复制完整的错误输出
   - 包括文件名和行号

2. **失败的步骤**
   - 是 "Install dependencies" 失败？
   - 还是 "Build" 步骤失败？

3. **本地构建结果**
   - 在本地运行 `npm run build` 是否成功？
   - 如果本地也失败，错误信息是什么？

---

## 下一步

1. **查看 GitHub Actions 详细日志**
   - 找到具体的错误消息
   - 复制错误信息

2. **根据错误类型选择解决方案**
   - 参考上面的常见错误解决方案

3. **修复后重新推送**
   ```powershell
   git add .
   git commit -m "Fix: Resolve build errors"
   git push origin main
   ```

---

## 总结

**构建失败的主要原因：**
1. TypeScript 类型错误
2. 中间件在静态导出时的问题
3. 缺少环境变量
4. 依赖问题
5. 文件路径错误

**推荐操作：**
1. ✅ 查看 GitHub Actions 详细错误日志
2. ✅ 在本地测试构建（`npm run build`）
3. ✅ 根据错误类型应用相应的修复方案
4. ✅ 修复后重新推送

---

**创建时间：** 2024年12月  
**状态：** ✅ 排查指南已创建

**请提供具体的错误消息，我可以帮您精确定位问题！**
