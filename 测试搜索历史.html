<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœç´¢å†å²åŠŸèƒ½æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #00776E;
        }
        .test-section h2 {
            margin-top: 0;
            color: #00776E;
        }
        button {
            background: #00776E;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #008080;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æœç´¢å†å²åŠŸèƒ½æµ‹è¯•å·¥å…·</h1>
        
        <div class="test-section">
            <h2>1. æŸ¥çœ‹å½“å‰æœç´¢å†å²</h2>
            <button onclick="viewHistory()">æŸ¥çœ‹å†å²</button>
            <div id="historyResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. æ·»åŠ æµ‹è¯•æ•°æ®</h2>
            <input type="text" id="testQuery" placeholder="è¾“å…¥æµ‹è¯•æœç´¢è¯" style="padding: 8px; width: 200px; margin-right: 10px;">
            <input type="number" id="testCount" placeholder="ç»“æœæ•°é‡" style="padding: 8px; width: 100px; margin-right: 10px;">
            <button onclick="addTestData()">æ·»åŠ æµ‹è¯•æ•°æ®</button>
            <div id="addResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. æ¸…é™¤æ‰€æœ‰å†å²</h2>
            <button onclick="clearHistory()">æ¸…é™¤å†å²</button>
            <div id="clearResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. åˆ é™¤å•æ¡å†å²</h2>
            <input type="text" id="removeQuery" placeholder="è¾“å…¥è¦åˆ é™¤çš„æœç´¢è¯" style="padding: 8px; width: 200px; margin-right: 10px;">
            <button onclick="removeItem()">åˆ é™¤</button>
            <div id="removeResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>5. æ‰¹é‡æµ‹è¯•</h2>
            <button onclick="batchTest()">æ‰§è¡Œæ‰¹é‡æµ‹è¯•</button>
            <div id="batchResult" class="result"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'isperm_search_history';
        const MAX_HISTORY = 20;

        function getHistory() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return [];
                return JSON.parse(stored).sort((a, b) => b.timestamp - a.timestamp);
            } catch (error) {
                console.error('Error reading history:', error);
                return [];
            }
        }

        function saveHistory(history) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
                return true;
            } catch (error) {
                console.error('Error saving history:', error);
                return false;
            }
        }

        function viewHistory() {
            const history = getHistory();
            const resultDiv = document.getElementById('historyResult');
            
            if (history.length === 0) {
                resultDiv.innerHTML = '<span class="info">æš‚æ— æœç´¢å†å²</span>';
                return;
            }

            let html = `<strong>å…± ${history.length} æ¡å†å²è®°å½•ï¼š</strong><br><br>`;
            history.forEach((item, index) => {
                const date = new Date(item.timestamp);
                html += `${index + 1}. "${item.query}" - ${item.resultCount || 0} ç»“æœ - ${date.toLocaleString()}<br>`;
            });
            
            resultDiv.innerHTML = html;
        }

        function addTestData() {
            const query = document.getElementById('testQuery').value.trim();
            const count = parseInt(document.getElementById('testCount').value) || 0;
            const resultDiv = document.getElementById('addResult');

            if (!query) {
                resultDiv.innerHTML = '<span class="error">è¯·è¾“å…¥æœç´¢è¯</span>';
                return;
            }

            const history = getHistory();
            const filtered = history.filter(item => item.query.toLowerCase() !== query.toLowerCase());
            const newItem = {
                query: query,
                timestamp: Date.now(),
                resultCount: count
            };
            const newHistory = [newItem, ...filtered].slice(0, MAX_HISTORY);
            
            if (saveHistory(newHistory)) {
                resultDiv.innerHTML = `<span class="success">âœ“ æˆåŠŸæ·»åŠ : "${query}"</span>`;
                viewHistory();
            } else {
                resultDiv.innerHTML = '<span class="error">âœ— ä¿å­˜å¤±è´¥</span>';
            }
        }

        function clearHistory() {
            const resultDiv = document.getElementById('clearResult');
            try {
                localStorage.removeItem(STORAGE_KEY);
                resultDiv.innerHTML = '<span class="success">âœ“ å†å²è®°å½•å·²æ¸…é™¤</span>';
                viewHistory();
            } catch (error) {
                resultDiv.innerHTML = '<span class="error">âœ— æ¸…é™¤å¤±è´¥: ' + error.message + '</span>';
            }
        }

        function removeItem() {
            const query = document.getElementById('removeQuery').value.trim();
            const resultDiv = document.getElementById('removeResult');

            if (!query) {
                resultDiv.innerHTML = '<span class="error">è¯·è¾“å…¥è¦åˆ é™¤çš„æœç´¢è¯</span>';
                return;
            }

            const history = getHistory();
            const filtered = history.filter(item => item.query.toLowerCase() !== query.toLowerCase());
            
            if (filtered.length === history.length) {
                resultDiv.innerHTML = '<span class="info">æœªæ‰¾åˆ°è¯¥æœç´¢è¯</span>';
                return;
            }

            if (saveHistory(filtered)) {
                resultDiv.innerHTML = `<span class="success">âœ“ æˆåŠŸåˆ é™¤: "${query}"</span>`;
                viewHistory();
            } else {
                resultDiv.innerHTML = '<span class="error">âœ— åˆ é™¤å¤±è´¥</span>';
            }
        }

        function batchTest() {
            const resultDiv = document.getElementById('batchResult');
            let results = [];
            let passed = 0;
            let failed = 0;

            // æµ‹è¯• 1: æ·»åŠ æ•°æ®
            results.push('æµ‹è¯• 1: æ·»åŠ æœç´¢å†å²...');
            const testQueries = ['Nexus Dx1', 'CASA system', 'WHO 6th Edition', 'Semen analysis'];
            testQueries.forEach((q, i) => {
                const history = getHistory();
                const filtered = history.filter(item => item.query.toLowerCase() !== q.toLowerCase());
                const newItem = { query: q, timestamp: Date.now() - i * 1000, resultCount: i * 5 };
                const newHistory = [newItem, ...filtered].slice(0, MAX_HISTORY);
                if (saveHistory(newHistory)) {
                    results.push(`  âœ“ æ·»åŠ  "${q}"`);
                    passed++;
                } else {
                    results.push(`  âœ— æ·»åŠ  "${q}" å¤±è´¥`);
                    failed++;
                }
            });

            // æµ‹è¯• 2: è¯»å–æ•°æ®
            results.push('<br>æµ‹è¯• 2: è¯»å–æœç´¢å†å²...');
            const history = getHistory();
            if (history.length > 0) {
                results.push(`  âœ“ æˆåŠŸè¯»å– ${history.length} æ¡è®°å½•`);
                passed++;
            } else {
                results.push('  âœ— è¯»å–å¤±è´¥æˆ–ä¸ºç©º');
                failed++;
            }

            // æµ‹è¯• 3: é‡å¤æœç´¢
            results.push('<br>æµ‹è¯• 3: é‡å¤æœç´¢å¤„ç†...');
            const duplicateQuery = 'Nexus Dx1';
            const historyBefore = getHistory();
            const beforeCount = historyBefore.filter(h => h.query.toLowerCase() === duplicateQuery.toLowerCase()).length;
            const filtered = historyBefore.filter(item => item.query.toLowerCase() !== duplicateQuery.toLowerCase());
            const newItem = { query: duplicateQuery, timestamp: Date.now(), resultCount: 10 };
            const newHistory = [newItem, ...filtered].slice(0, MAX_HISTORY);
            saveHistory(newHistory);
            const historyAfter = getHistory();
            const afterCount = historyAfter.filter(h => h.query.toLowerCase() === duplicateQuery.toLowerCase()).length;
            if (afterCount === 1 && historyAfter[0].query === duplicateQuery) {
                results.push(`  âœ“ é‡å¤æœç´¢æ­£ç¡®å¤„ç†ï¼ˆåˆå¹¶ä¸º1æ¡ï¼Œç§»åˆ°æœ€å‰ï¼‰`);
                passed++;
            } else {
                results.push(`  âœ— é‡å¤æœç´¢å¤„ç†å¤±è´¥`);
                failed++;
            }

            // æµ‹è¯• 4: æ•°é‡é™åˆ¶
            results.push('<br>æµ‹è¯• 4: å†å²æ•°é‡é™åˆ¶...');
            const manyQueries = Array.from({ length: 25 }, (_, i) => `Test Query ${i}`);
            manyQueries.forEach((q, i) => {
                const h = getHistory();
                const filtered = h.filter(item => item.query.toLowerCase() !== q.toLowerCase());
                const newItem = { query: q, timestamp: Date.now() - i * 1000, resultCount: i };
                const newHistory = [newItem, ...filtered].slice(0, MAX_HISTORY);
                saveHistory(newHistory);
            });
            const finalHistory = getHistory();
            if (finalHistory.length <= MAX_HISTORY) {
                results.push(`  âœ“ æ•°é‡é™åˆ¶æ­£ç¡®ï¼ˆå½“å‰ ${finalHistory.length} æ¡ï¼Œé™åˆ¶ ${MAX_HISTORY} æ¡ï¼‰`);
                passed++;
            } else {
                results.push(`  âœ— æ•°é‡é™åˆ¶å¤±è´¥ï¼ˆå½“å‰ ${finalHistory.length} æ¡ï¼Œåº” â‰¤ ${MAX_HISTORY} æ¡ï¼‰`);
                failed++;
            }

            // æ€»ç»“
            results.push(`<br><strong>æµ‹è¯•æ€»ç»“ï¼š</strong>`);
            results.push(`é€šè¿‡: ${passed} | å¤±è´¥: ${failed} | æ€»è®¡: ${passed + failed}`);
            
            resultDiv.innerHTML = results.join('<br>');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æŸ¥çœ‹å†å²
        window.onload = function() {
            viewHistory();
        };
    </script>
</body>
</html>
