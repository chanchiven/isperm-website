# 自动语言检测功能说明

## 功能概述

网站现在已启用**自动语言检测**功能，会根据访客的浏览器语言设置自动匹配最合适的语言版本。

## 工作原理

当访客访问网站时，系统会按以下**优先级顺序**检测语言：

### 1. URL 语言前缀（最高优先级）
如果 URL 中已经包含语言代码，直接使用该语言：
- 例如：`/de/about` → 使用德语
- 例如：`/es/products` → 使用西班牙语

### 2. Cookie 记忆（次优先级）
如果用户之前访问过网站并选择了语言，会记住用户的选择：
- Cookie 名称：`NEXT_LOCALE`
- 如果存在，优先使用 Cookie 中的语言

### 3. 浏览器语言设置（自动检测）
检测浏览器的 `Accept-Language` header，自动匹配最合适的语言：

**支持的语言映射：**
- `en`, `en-US`, `en-GB` → `en` (英语)
- `es`, `es-ES`, `es-MX` → `es` (西班牙语)
- `ar`, `ar-SA`, `ar-EG` → `ar` (阿拉伯语)
- `de`, `de-DE`, `de-AT` → `de` (德语)
- `it`, `it-IT` → `it` (意大利语)
- `pt`, `pt-BR`, `pt-PT` → `pt` (葡萄牙语)
- `ru`, `ru-RU` → `ru` (俄语)
- `tr`, `tr-TR` → `tr` (土耳其语)
- `fr`, `fr-FR`, `fr-CA` → `fr` (法语)
- `pl`, `pl-PL` → `pl` (波兰语)
- `nl`, `nl-NL`, `nl-BE` → `nl` (荷兰语)
- `ko`, `ko-KR` → `ko` (韩语)
- `ja`, `ja-JP` → `ja` (日语)
- `vi`, `vi-VN` → `vi` (越南语)
- `id`, `id-ID` → `id` (印尼语)
- `uk`, `uk-UA` → `uk` (乌克兰语)
- `bg`, `bg-BG` → `bg` (保加利亚语)
- `ro`, `ro-RO` → `ro` (罗马尼亚语)

**如果浏览器语言不在支持列表中：**
- 使用默认语言：`en` (英语)

### 4. 默认语言（后备方案）
如果以上都无法确定，使用默认语言 `en` (英语)

---

## 使用场景示例

### 场景 1：首次访问
1. 用户浏览器语言设置为 `德语 (de-DE)`
2. 用户访问 `https://yoursite.com/`
3. 系统检测到浏览器语言是德语
4. 自动重定向到 `https://yoursite.com/de/`
5. 显示德语版本

### 场景 2：已选择过语言
1. 用户之前访问过网站，选择了 `西班牙语 (es)`
2. Cookie 中保存了 `NEXT_LOCALE=es`
3. 用户再次访问 `https://yoursite.com/`
4. 系统优先使用 Cookie 中的语言
5. 自动重定向到 `https://yoursite.com/es/`
6. 显示西班牙语版本

### 场景 3：直接访问特定语言
1. 用户直接访问 `https://yoursite.com/de/about`
2. URL 中已包含语言代码 `de`
3. 直接显示德语版本，不进行检测

### 场景 4：浏览器语言不支持
1. 用户浏览器语言设置为 `中文 (zh-CN)`
2. 网站不支持中文
3. 使用默认语言 `en` (英语)
4. 重定向到 `https://yoursite.com/en/`

---

## 测试方法

### 方法 1：修改浏览器语言设置

**Chrome/Edge:**
1. 打开浏览器设置
2. 搜索 "语言"
3. 添加或调整语言优先级
4. 清除网站 Cookie（避免 Cookie 干扰）
5. 访问网站根路径 `/`
6. 应该自动重定向到匹配的语言

**Firefox:**
1. 打开 `about:preferences#general`
2. 找到 "语言" 部分
3. 选择语言
4. 清除网站 Cookie
5. 访问网站根路径

**Safari:**
1. 系统偏好设置 → 语言与地区
2. 调整语言顺序
3. 清除网站 Cookie
4. 访问网站根路径

### 方法 2：使用开发者工具

1. 打开浏览器开发者工具 (F12)
2. 切换到 "Network" 标签
3. 清除网站 Cookie
4. 刷新页面
5. 查看请求头中的 `Accept-Language`
6. 确认重定向到正确的语言路径

### 方法 3：使用 curl 测试

```bash
# 测试德语检测
curl -H "Accept-Language: de-DE,de;q=0.9" -I http://localhost:3000/

# 测试西班牙语检测
curl -H "Accept-Language: es-ES,es;q=0.9" -I http://localhost:3000/

# 测试法语检测
curl -H "Accept-Language: fr-FR,fr;q=0.9" -I http://localhost:3000/
```

应该看到 `Location` header 指向对应的语言路径。

---

## 配置说明

### 当前配置

**文件：`i18n/routing.ts`**
```typescript
export const routing = defineRouting({
  locales: ['en', 'es', 'ar', 'de', 'it', 'pt', 'ru', 'tr', 'fr', 'pl', 'nl', 'ko', 'ja', 'vi', 'id', 'uk', 'bg', 'ro'],
  defaultLocale: 'en',
  localePrefix: 'always',
  localeDetection: true, // 启用自动检测
});
```

**文件：`app/middleware.ts`**
- 已配置自动语言检测
- 处理重复语言代码的情况
- 自动重定向到匹配的语言路径

---

## 注意事项

### 1. Cookie 优先级
- 如果用户之前选择过语言，Cookie 会覆盖浏览器语言设置
- 要测试浏览器语言检测，需要先清除 Cookie

### 2. 语言代码映射
- 系统会自动处理语言代码变体（如 `de-DE` → `de`）
- 只支持配置中列出的语言

### 3. SEO 考虑
- 所有语言路径都包含语言前缀（`localePrefix: 'always'`）
- 有利于搜索引擎优化

### 4. 用户手动选择
- 用户可以通过语言切换器手动选择语言
- 选择后会保存到 Cookie，下次访问时优先使用

---

## 故障排除

### 问题 1：没有自动检测到浏览器语言

**可能原因：**
- Cookie 中已保存了其他语言
- 浏览器语言不在支持列表中

**解决方法：**
1. 清除网站 Cookie
2. 确认浏览器语言在支持列表中
3. 检查中间件配置是否正确

### 问题 2：总是显示默认语言

**可能原因：**
- 浏览器语言不在支持列表中
- `localeDetection` 未启用

**解决方法：**
1. 检查 `i18n/routing.ts` 中 `localeDetection: true`
2. 确认浏览器语言在 `locales` 数组中
3. 查看浏览器开发者工具的 Network 标签，检查 `Accept-Language` header

### 问题 3：重定向循环

**可能原因：**
- 中间件配置错误
- 路径处理逻辑问题

**解决方法：**
1. 检查 `app/middleware.ts` 中的路径处理逻辑
2. 确认没有重复的语言代码处理
3. 查看服务器日志中的错误信息

---

## 相关文件

- `app/middleware.ts` - 中间件配置
- `i18n/routing.ts` - 路由和语言配置
- `components/LanguageSwitcher.tsx` - 语言切换器组件

---

**最后更新：** 2024-12
