# 中文用户404重定向功能说明

## 功能概述

当检测到访客的浏览器语言是简体中文或繁体中文（台湾），或者IP地址来自中国、台湾（不包括香港）时，系统会直接返回一个最简单的404页面（没有任何装修）。

## 检测条件

系统会检测以下两个条件，**满足任一条件**即触发：

### 1. 浏览器语言检测
检测 `Accept-Language` header，**只匹配以下语言代码**：
- `zh-CN` (简体中文 - 中国大陆)
- `zh-TW` (繁体中文 - 台湾)

**不匹配的语言代码（允许正常访问）：**
- `zh-HK` (繁体中文 - 香港) - **已排除**
- `zh-SG` (简体中文 - 新加坡) - **已排除**
- `zh-MO` (繁体中文 - 澳门) - **已排除**
- `zh` (通用中文，无地区代码) - **已排除**

**匹配规则：**
- 只匹配 `zh-CN` 或 `zh-TW`
- 支持 `zh-CN`、`zh_CN` 等格式
- 明确排除 `zh-HK`，允许香港用户正常访问

### 2. IP地址地理位置检测
检测访客IP地址所在国家/地区，**只检测以下地区**：
- `CN` - 中国（不包括香港）
- `TW` - 台湾

**不检测的地区（允许正常访问）：**
- `HK` - 香港 - **已排除**

**注意：**
- 在 Vercel 平台上，`request.geo` 会自动提供地理位置信息
- 在其他平台（如自托管），可能需要配置IP地理位置服务
- 如果地理位置信息不可用，系统会回退到仅使用语言检测

## 返回的404页面

当满足条件时，系统会返回一个**最简单的404页面**：

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>404</title>
</head>
<body>
  <h1>404</h1>
  <p>Not Found</p>
</body>
</html>
```

**特点：**
- ✅ 没有任何样式（CSS）
- ✅ 没有任何JavaScript
- ✅ 没有任何导航栏、Footer等组件
- ✅ 没有任何图片或装饰
- ✅ 纯HTML，最简单的404页面

## 实现位置

**文件：** `app/middleware.ts`

**关键代码：**
```typescript
// 检测是否为中文用户（简体或繁体）或中国/台湾IP（不包括香港）
function isChineseUser(request: NextRequest): boolean {
  // 1. 检测浏览器语言
  // 只匹配简体中文(zh-CN)和繁体中文-台湾(zh-TW)
  // 注意：排除香港(zh-HK)，允许香港用户正常访问
  const acceptLanguage = request.headers.get('accept-language') || '';
  const isChineseLang = /zh[-_]?(CN|TW)/i.test(acceptLanguage);
  
  // 2. 检测IP地址地理位置
  // 只检测中国(CN)和台湾(TW)，不包括香港(HK)
  const country = request.geo?.country || '';
  const isChineseIP = country === 'CN' || country === 'TW';
  
  return isChineseLang || isChineseIP;
}

// 在中间件中检测
if (isChineseUser(request)) {
  return new NextResponse(
    `<!DOCTYPE html>...`, // 简单404页面
    { status: 404, headers: { 'Content-Type': 'text/html; charset=utf-8' } }
  );
}
```

## 测试方法

### 方法1：修改浏览器语言

1. 打开浏览器设置
2. 将语言设置为中文（简体或繁体）
3. 清除网站Cookie
4. 访问网站任意路径
5. 应该看到简单的404页面

### 方法2：使用curl测试

```bash
# 测试简体中文语言检测
curl -H "Accept-Language: zh-CN,zh;q=0.9" -I http://localhost:3000/

# 测试繁体中文语言检测
curl -H "Accept-Language: zh-TW,zh;q=0.9" -I http://localhost:3000/

# 应该返回 404 状态码和简单HTML
```

### 方法3：使用VPN测试IP检测

1. 使用VPN连接到中国或台湾
2. 访问网站
3. 应该看到简单的404页面

**注意：** 香港IP不会被拦截，可以正常访问网站

## 注意事项

### 1. IP地理位置检测限制

- **Vercel平台：** 自动支持，无需配置
- **其他平台：** 可能需要配置IP地理位置服务
- **开发环境：** `request.geo` 可能不可用，主要依赖语言检测

### 2. 优先级

检测顺序：
1. 首先检测浏览器语言
2. 然后检测IP地理位置
3. 满足任一条件即触发

### 3. 绕过检测

如果用户满足以下任一条件，可以正常访问网站：
- 使用非中文浏览器语言（如英语、德语等）
- 使用 `zh-HK`（香港繁体中文）
- 使用 `zh-SG`（新加坡简体中文）
- 使用 `zh-MO`（澳门繁体中文）
- IP地址在香港（HK）
- IP地址不在CN或TW

### 4. 性能考虑

- 检测逻辑在中间件中执行，非常快速
- 不会影响其他用户的访问速度
- 简单404页面响应时间极短

## 部署说明

### Vercel部署

✅ **自动支持** - Vercel自动提供 `request.geo` 信息，无需额外配置

### 其他平台部署

如果需要在其他平台使用IP地理位置检测，可能需要：

1. **配置IP地理位置服务**
   - 使用 MaxMind GeoIP2
   - 或使用 Cloudflare 的地理位置功能
   - 或其他IP地理位置API

2. **修改中间件代码**
   ```typescript
   // 如果 geo 不可用，可以调用第三方API
   // 或者仅依赖语言检测
   ```

## 相关文件

- `app/middleware.ts` - 中间件实现
- 此说明文档

---

**最后更新：** 2024-12
