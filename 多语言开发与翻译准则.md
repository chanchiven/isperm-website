# 多语言开发与翻译准则

## 文档概述

本文档基于 Next.js + next-intl 多语言网站开发实践经验，旨在规范多语言开发流程，避免常见错误，确保翻译质量和代码可维护性。

---

## 1. 文件架构规范

### 1.1 Source of Truth 原则

- **英文（en）作为唯一标准源**
  - 所有翻译文件的 JSON 结构必须与 `messages/en/` 目录下的文件完全一致
  - 新增翻译键时，必须先更新英文版本，再同步到其他语言
  - 英文版本是功能完整性的参考标准

### 1.2 文件结构要求

```
messages/
├── en/              # 英文（Source of Truth）
│   ├── index.json
│   ├── about.json
│   ├── products.json
│   ├── contact.json
│   └── faq.json
├── es/              # 西班牙语
├── de/              # 德语
├── fr/              # 法语
└── [其他语言]/
```

**要求**：
- 所有语言目录下的文件名必须一致
- 每个 JSON 文件的结构（键名）必须完全一致
- 键名（Key）必须保持英文，不允许翻译或改变

### 1.3 翻译键命名规范

```json
{
  "meta": {
    "title": "...",
    "description": "..."
  },
  "nav": {
    "home": "...",
    "products": "..."
  },
  "footer": {
    "company": "...",
    "description": "...",
    "fullAddress": "..."  // 必须在正确的对象层级下
  }
}
```

**关键点**：
- 键名必须与英文版本严格对应
- 嵌套结构必须保持一致
- 注意键的位置（如 `footer.fullAddress` 必须在 `footer` 对象下，而不是 `contact.fullAddress`）

---

## 2. 代码规范

### 2.1 next-intl 使用规范

#### 路由配置（`i18n/routing.ts`）

```typescript
export const routing = defineRouting({
  locales: ['en', 'es', 'de', 'fr', ...], // 所有支持的语言
  defaultLocale: 'en',
  localePrefix: 'always', // 始终显示语言前缀，对 SEO 更好
  pathnames: {
    '/': '/',
    '/about': '/about',
    // ... 所有路由路径
  }
});

export const {Link, redirect, usePathname, useRouter} = createNavigation(routing);
```

**要求**：
- 新增语言时，必须同步更新 `locales` 数组
- 路由路径必须在 `pathnames` 中明确定义

#### Link 组件使用规范

**❌ 错误示例**：
```tsx
<Link href="/products">产品</Link>  // 未传递 locale
```

**✅ 正确示例**：
```tsx
// 服务端组件
<Link href="/products" locale={locale as any}>{t('nav.products')}</Link>

// 客户端组件
const locale = useLocale();
<Link href="/products" locale={locale as any}>{t('nav.products')}</Link>
```

**关键规则**：
- **所有内部链接必须显式传递 `locale` 参数**
- 使用 `next-intl` 的 `Link` 组件（从 `@/i18n/routing` 导入）
- 导航栏、Footer、Breadcrumb 等所有链接都需要传递 locale

#### 导航组件规范

**创建统一的 Navigation 客户端组件**：
```tsx
// components/Navigation.tsx
'use client';

import {Link} from '@/i18n/routing';
import {useTranslations, useLocale} from 'next-intl';
import {LanguageSwitcher} from '@/components/LanguageSwitcher';

export function Navigation() {
  const t = useTranslations('index'); // 或相应的 namespace
  const locale = useLocale();
  
  return (
    <nav className="navbar">
      {/* ... */}
      <Link href="/products" locale={locale as any}>
        {t('nav.products')}
      </Link>
      {/* ... */}
    </nav>
  );
}
```

**要求**：
- 导航栏必须使用客户端组件（因为需要 `useLocale()` hook）
- 不要在服务端组件中传递 `t` 函数给客户端组件
- 使用 `useTranslations` hook 在客户端组件中获取翻译

#### Middleware 配置（`app/middleware.ts`）

```typescript
import createMiddleware from 'next-intl/middleware';
import {routing} from '../i18n/routing';
import {NextRequest, NextResponse} from 'next/server';

const intlMiddleware = createMiddleware(routing);

export default function middleware(request: NextRequest) {
  const {pathname} = request.nextUrl;
  
  // 处理重复语言代码的情况，如 /es/es -> /es
  const pathSegments = pathname.split('/').filter(Boolean);
  if (pathSegments.length >= 2) {
    const firstSegment = pathSegments[0];
    const secondSegment = pathSegments[1];
    
    if (routing.locales.includes(firstSegment) && 
        routing.locales.includes(secondSegment) && 
        firstSegment === secondSegment) {
      const remainingPath = pathSegments.slice(1).join('/');
      const correctPath = remainingPath ? `/${firstSegment}/${remainingPath}` : `/${firstSegment}`;
      const redirectUrl = new URL(correctPath, request.url);
      redirectUrl.search = request.nextUrl.search;
      return NextResponse.redirect(redirectUrl);
    }
  }
  
  return intlMiddleware(request);
}

export const config = {
  matcher: ['/((?!api|_next|.*\\..*).*)']
};
```

---

## 3. 翻译质量控制

### 3.1 核心术语表

以下术语在所有语言中必须保持一致，确保专业性和准确性：

| 英文术语 | 中文 | 说明 |
|---------|------|------|
| CASA | CASA | 保持原样，不翻译 |
| Semen Analyzer | 精液分析仪 | 根据语境调整 |
| Sperm Morphology | 精子形态学 | 专业术语 |
| WHO 6th Edition | 世界卫生组织第六版 | 标准引用 |
| Reproductive Health | 生殖健康 | 医学术语 |
| Andrology | 男科学 | 专业术语 |
| Microfluidics | 微流控 | 技术术语 |
| AI-powered | AI驱动 | 技术描述 |

**规则**：
- 专业术语优先使用国际通用名称（如 CASA）
- 必须参考医学文献和行业标准
- 同一术语在整个网站中保持统一

### 3.2 语气要求

**目标语气**：医疗临床级别的专业、严谨语气

**要求**：
- ✅ 使用正式、专业的语言风格
- ✅ 避免口语化表达
- ✅ 保持客观、科学的描述方式
- ❌ 避免使用过于营销化的词汇
- ❌ 避免使用感叹号、过度强调

**示例**：

| ❌ 不推荐 | ✅ 推荐 |
|----------|--------|
| 革命性的突破！ | 创新的技术解决方案 |
| 最好的产品！ | 行业领先的解决方案 |
| 立即购买！ | 了解更多信息 |

### 3.3 格式保留规则

**必须保留的内容**：
- HTML 标签：`<br/>`, `<strong>`, `<em>`, `<a>` 等
- 变量占位符：`{variable}`, `{{variable}}`
- 特殊符号：`°C`, `%`, `±` 等
- 换行符和空格（如有特殊格式要求）

**示例**：
```json
{
  "description": "温度控制：<strong>37°C</strong>，精确度：±0.1°C",
  "multiline": "第一行<br/>第二行"
}
```

---

## 4. UI 弹性设计原则

### 4.1 文本长度差异处理

不同语言的文本长度差异很大，需要确保 UI 在不同语言下都能正确对齐。

#### 使用 Flexbox 布局

```tsx
// 卡片布局示例
<div style={{
  display: 'flex',
  flexDirection: 'column',
  height: '100%'  // 确保卡片高度一致
}}>
  <div style={{flex: '1'}}>
    {/* 图标、标题、描述等可变内容 */}
    <h3 style={{
      minHeight: '4.32rem',  // 标题最小高度
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }}>
      {title}
    </h3>
    <p style={{
      minHeight: '5.5rem'  // 描述文本最小高度
    }}>
      {description}
    </p>
  </div>
  <div style={{marginTop: '2rem'}}>
    {/* 按钮 - 固定在底部 */}
    <button>{buttonText}</button>
  </div>
</div>
```

#### 使用 CSS Grid 确保对齐

```css
.action-cards-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  align-items: stretch; /* 确保所有卡片高度一致 */
}
```

### 4.2 对齐最佳实践

1. **图标对齐**：使用固定的图标尺寸和间距
2. **标题对齐**：设置 `minHeight` 确保多行标题也能对齐
3. **描述文本对齐**：设置 `minHeight` 处理不同行数
4. **按钮对齐**：使用 Flexbox 将按钮固定在底部

### 4.3 响应式设计

```css
@media (max-width: 968px) {
  .action-cards-grid {
    grid-template-columns: 1fr; /* 移动端单列显示 */
    gap: 2rem;
  }
}
```

---

## 5. SEO 规范

### 5.1 Meta 标签翻译

**每个语言必须独立翻译以下 Meta 标签**：

```json
{
  "meta": {
    "title": "页面标题 - 语言特定的描述",
    "description": "页面描述，包含关键词，长度建议 150-160 字符"
  }
}
```

**要求**：
- ✅ 每种语言必须有独立的 Meta Title 和 Description
- ✅ Title 长度建议：50-60 字符
- ✅ Description 长度建议：150-160 字符
- ✅ 包含核心关键词（CASA, Semen Analyzer 等）
- ❌ 不要直接翻译英文，要根据目标语言的搜索习惯优化

### 5.2 图片 ALT 标签

```json
{
  "image": "/path/to/image.jpg",
  "alt": "描述图片内容的文本，包含关键词"
}
```

**要求**：
- ✅ 所有图片必须有 ALT 文本
- ✅ ALT 文本应该描述图片内容，而非仅重复文件名
- ✅ 包含相关关键词，但要自然
- ❌ 避免关键词堆砌

### 5.3 结构化数据

如果使用结构化数据（Schema.org），确保：
- 文本内容使用对应语言的翻译
- 保持数据结构一致

---

## 6. 执行流程

### 6.1 三步翻译法

#### 步骤 1：分块翻译

**原则**：不要一次性翻译整个文件，按功能模块分块进行

**分块策略**：
1. **Meta 信息**：title, description
2. **导航栏**：nav 对象
3. **主要内容**：hero, features, sections 等
4. **Footer**：footer 对象
5. **表单/交互元素**：form, buttons 等

**好处**：
- 避免文件过大导致编辑器卡顿
- 便于审查和修改
- 降低出错风险

#### 步骤 2：注入 JSON

**流程**：
1. 复制英文版本的 JSON 结构
2. 逐个键值对进行翻译
3. 保持 JSON 格式正确（注意逗号、引号）
4. 验证 JSON 语法（可使用在线 JSON 验证工具）

**检查清单**：
- [ ] 所有键名与英文版本一致
- [ ] JSON 语法正确（无多余逗号、括号匹配）
- [ ] 特殊字符正确转义
- [ ] HTML 标签和占位符保留

#### 步骤 3：视觉审计

**测试项目**：

1. **功能测试**：
   - [ ] 所有链接正确保留语言
   - [ ] 语言切换器工作正常
   - [ ] 导航栏链接正确
   - [ ] Footer 链接正确

2. **视觉测试**：
   - [ ] 文本对齐正确
   - [ ] 按钮对齐
   - [ ] 卡片布局一致
   - [ ] 响应式布局正常

3. **内容测试**：
   - [ ] 所有文本正确显示（无翻译键显示）
   - [ ] Meta 标签正确
   - [ ] 图片 ALT 文本正确

4. **SEO 测试**：
   - [ ] 页面 Title 正确
   - [ ] Meta Description 正确
   - [ ] 所有语言的 URL 可访问

### 6.2 翻译工作流程

```
1. 选择目标语言（如德语 de）
   ↓
2. 创建/更新 messages/de/ 目录下的文件
   ↓
3. 分块翻译（按步骤 6.1）
   ↓
4. 注入 JSON（按步骤 6.2）
   ↓
5. 更新路由配置（i18n/routing.ts）
   ↓
6. 更新语言切换器（LanguageSwitcher.tsx）
   ↓
7. 视觉审计（按步骤 6.3）
   ↓
8. 修复问题，重复步骤 7 直到通过
   ↓
9. 提交代码
```

---

## 7. 常见错误及解决方案

### 7.1 翻译键显示问题

**问题**：页面上显示 `contact.footer.fullAddress` 而不是实际地址

**原因**：翻译键位置错误，代码使用 `t('footer.fullAddress')` 但 JSON 中键在 `contact.fullAddress`

**解决**：确保键的位置与代码中使用的路径一致

### 7.2 语言切换后跳转到英文

**问题**：点击语言切换器后，页面跳转到英文版本

**原因**：
1. Link 组件未传递 `locale` 参数
2. 使用了服务端组件的 `t` 函数传递给客户端组件

**解决**：
1. 所有 Link 组件显式传递 `locale={locale as any}`
2. 创建客户端组件，使用 `useTranslations` hook

### 7.3 文本对齐问题

**问题**：不同语言的文本长度导致布局不对齐

**原因**：未使用弹性布局，固定高度或间距

**解决**：
1. 使用 Flexbox 和 Grid 布局
2. 设置合理的 `minHeight`
3. 使用 `flex: 1` 让内容区域自适应

### 7.4 翻译文件截断

**问题**：翻译过程中文件被截断，导致 JSON 语法错误

**原因**：一次性编辑大文件，编辑器或系统问题导致保存不完整

**解决**：
1. 分块翻译（见步骤 6.1）
2. 每次保存后验证 JSON 语法
3. 使用版本控制（Git）备份

---

## 8. 检查清单

### 8.1 新增语言检查清单

- [ ] 在 `i18n/routing.ts` 中添加新语言到 `locales` 数组
- [ ] 在 `components/LanguageSwitcher.tsx` 中添加语言选项
- [ ] 创建 `messages/[locale]/` 目录
- [ ] 翻译所有 JSON 文件（index, about, products, contact, faq 等）
- [ ] 验证所有 JSON 文件语法正确
- [ ] 测试所有页面的语言切换
- [ ] 验证所有链接保留语言
- [ ] 检查 Meta 标签和 SEO
- [ ] 视觉审计所有页面
- [ ] 测试响应式布局

### 8.2 翻译质量检查清单

- [ ] 所有键名与英文版本一致
- [ ] 核心术语使用正确
- [ ] 语气符合专业要求
- [ ] HTML 标签和占位符保留
- [ ] Meta Title 和 Description 独立翻译
- [ ] 图片 ALT 文本翻译
- [ ] 文本长度适配 UI 布局

---

## 9. 工具推荐

### 9.1 JSON 验证工具
- [JSONLint](https://jsonlint.com/) - 在线 JSON 验证
- VS Code JSON 插件 - 实时验证

### 9.2 翻译工具
- DeepL - 高质量机器翻译（作为参考）
- Google Translate - 快速参考
- **注意**：所有翻译必须人工审核，不能直接使用机器翻译

### 9.3 开发工具
- Next.js Dev Tools - 开发调试
- React DevTools - 组件调试
- Browser DevTools - 网络和性能分析

---

## 10. 附录

### 10.1 参考资源

- [next-intl 官方文档](https://next-intl-docs.vercel.app/)
- [Next.js 国际化指南](https://nextjs.org/docs/advanced-features/i18n-routing)
- [WHO 术语表](https://www.who.int/) - 医学术语参考

### 10.2 术语库维护

建议维护一个统一的术语库文件（如 `terminology.md`），记录：
- 核心术语的英文和对应翻译
- 特殊用法说明
- 更新历史

---

## 文档版本

- **版本**：1.0
- **创建日期**：2024
- **最后更新**：2024
- **维护者**：开发团队

---

**重要提醒**：本文档基于实际项目经验总结，应根据项目具体情况调整。在开始新语言的翻译前，请仔细阅读本文档，并遵循其中的规范。

